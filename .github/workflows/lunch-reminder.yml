name: åˆé¤æé†’æœºå™¨äºº

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©11:15ï¼ŒUTCæ—¶é—´ï¼Œéœ€è¦æ ¹æ®ä½ çš„æ—¶åŒºè°ƒæ•´ï¼‰
  schedule:
    - cron: "15 3 * * *" # UTC 03:15 = åŒ—äº¬æ—¶é—´ 11:15 (UTC+8)
  # ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºæ¯å¤©å¤šä¸ªæ—¶é—´ç‚¹
  # schedule:
  #   - cron: '0 4 * * *'   # åŒ—äº¬æ—¶é—´ 12:00
  #   - cron: '0 5 * * *'   # åŒ—äº¬æ—¶é—´ 13:00

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    # å¦‚æœè®¾ç½®äº† environmentï¼Œåœ¨è¿™é‡ŒæŒ‡å®šç¯å¢ƒåç§°
    # environment: production  # å–æ¶ˆæ³¨é‡Šå¹¶æ”¹ä¸ºä½ çš„ç¯å¢ƒåç§°

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ç¼–è¯‘ TypeScript
        run: pnpm run build

      - name: è·å– IP åœ°å€
        run: |
          echo "ğŸŒ GitHub Actions Runner IP åœ°å€:"
          echo "IPv4:"
          curl -s https://api.ipify.org || echo "æ— æ³•è·å– IPv4"
          echo ""
          echo "IPv6:"
          curl -s https://api64.ipify.org || echo "æ— æ³•è·å– IPv6"
          echo ""
          echo "è¯¦ç»† IP ä¿¡æ¯:"
          curl -s https://ipinfo.io/json || echo "æ— æ³•è·å–è¯¦ç»†ä¿¡æ¯"

      - name: è¿è¡Œæé†’ä»»åŠ¡
        env:
          # ä» GitHub Secrets ä¸­è¯»å–ç¯å¢ƒå˜é‡
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
          WEATHER_CITY: ${{ vars.WEATHER_CITY }}
          WEATHER_LAT: ${{ vars.WEATHER_LAT }}
          WEATHER_LON: ${{ vars.WEATHER_LON }}
          NEWAPI_TOKEN: ${{ secrets.NEWAPI_TOKEN }}
          NEWAPI_MODEL: ${{ secrets.NEWAPI_MODEL }}
          REMINDER_HOUR: ${{ secrets.REMINDER_HOUR }}
          REMINDER_MINUTE: ${{ secrets.REMINDER_MINUTE }}
        run: pnpm start
